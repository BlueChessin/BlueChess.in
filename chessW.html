<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blue Chess.in â€“ Chess Videos</title>
  <meta name="description" content="Join the Blue Chess.in online lobby to challenge friends and players around the world. Start your match instantly.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="files/img/-s-logo.png" type="image/png">
  <link rel="stylesheet" href="./files/css/friendRes.css">
  <style>
    :root {
      --bg:#0b1f3a;
      --panel:#0f2b55;
      --muted:#aac7ff;
      --brand:#4aa3ff;
      --danger:#ff4d4d;
      --ok:#22c55e;
      --text:#e6f0ff;
      --shadow:rgba(74,163,255,.6);
    }
    body {
      font-family: Inter, sans-serif;
      background: linear-gradient(120deg,#02122a,#0f2b55);
      margin: 0;
      color: var(--text);
      overflow-x: hidden;
    }
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: -1;
      top: 0;
      left: 0;
    }
    .title-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 20px;
      margin: 0;
      background: linear-gradient(90deg, #003467, #0084a4, #22c55e);
      background-size: 200% 200%;
      animation: gradientShift 6s infinite alternate;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      position: relative;
    }
    .title-bar h1 {
      margin: 0;
      font-size: 2em;
      font-weight: 700;
      color: white;
      letter-spacing: 1px;
      text-shadow: 0 0 8px rgba(255,255,255,.6);
    }
    .title-logo {
      height: 50px;
      width: auto;
      filter: drop-shadow(0 0 8px rgba(74,163,255,.8));
    }
    #goHome {
      position: absolute;
      top: 20px;
      left: 20px;
      padding: 10px 15px;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 0 12px var(--shadow);
      transition: background .2s, transform .2s;
    }
    #goHome:focus {
      outline: 2px solid var(--brand);
    }
    #goHome:hover {
      background: #2d8cff;
      transform: scale(1.05);
    }
    @keyframes gradientShift {
      from { background-position: 0% 50%; }
      to { background-position: 100% 50%; }
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
    }
    .videos-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .video-item {
      background: var(--panel);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 16px;
      transition: box-shadow .2s;
    }
    .video-item:hover {
      box-shadow: 0 4px 16px var(--shadow);
    }
    .video-item h3 {
      margin-top: 0;
      color: var(--brand);
    }
    /* Banners */
    .banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 22px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      cursor: pointer;
      z-index: 9999;
      animation: floatIn 0.4s ease-out;
    }
    @keyframes floatIn {
      from { opacity: 0; transform: translate(-50%, 20px); }
      to   { opacity: 1; transform: translate(-50%, 0); }
    }
    #joinBanner { background: #28a745; color: white; }
    #challengeBanner { background: #ffc107; color: black; cursor: default; }
    .banner button {
      margin-left: 8px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .banner #green { background: #28a745; color: white; }
    .banner #red { background: #ff4d4d; color: white; }
  </style>
</head>
<body>
<div id="particles-js" aria-hidden="true"></div>

<!-- Title Bar -->
<header class="title-bar" role="banner">
  <button id="goHome" aria-label="Go Home" onclick="window.location.href='home.html'">Go Home</button>
  <img src="files/img/-w-logo.png" alt="BlueChess.in logo" class="title-logo" loading="lazy">
  <h1>Chess Videos</h1>
</header>

<main class="container" role="main">
  <section class="videos-list" id="videoslist" aria-live="polite">
    <p>Loading videos...</p>
  </section>
</main>

<audio id="challengeSound" src="files/sound/challenge.wav" preload="auto"></audio>
<audio id="acceptedSound" src="files/sound/accepted.wav" preload="auto"></audio>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js" defer></script>
<script src="files/js/friendRes.js" type="module" defer></script>
<script type="module">
/* Supabase setup */
const SUPABASE_URL = "https://ruevzmnbhoowmuleeqjb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZXZ6bW5iaG9vd211bGVlcWpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzOTUzNTIsImV4cCI6MjA2OTk3MTM1Mn0.tt_xEAqLGiv92mvqhQaEvsjTBE6cmYDC3kkQcyPqsTY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;

(async function init() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  // Banned check
    const { data: profile } = await supabaseClient.from("profiles").select("banned").eq("id", user.id).single();
    if (profile && profile.banned) {
      window.location.href = "banned.html";
      return;
    }

    // Maintenance check
    const { data: settings } = await supabaseClient.from("settings").select("maintenance").limit(1).single();
    if (settings && settings.maintenance) {
      window.location.href = "maintenance.html";
      return;
    }
  currentUserId = user.id;
  listenForMatchUpdates();
  loadVideos();
})();

import { initFriendSystem, sendFriendRequest } from "./files/js/friendRes.js";
initFriendSystem(); 

async function loadVideos() {
  // Fetch videos from Supabase "videos" table
  const { data: videos, error } = await supabaseClient
    .from("videos")
    .select("title,url,author")
    .order("id");

  const container = document.getElementById("videoslist");
  if (error) {
    console.error("Failed to load videos:", error);
    container.innerHTML = "<p>Failed to load videos.</p>";
    return;
  }
  if (!videos || videos.length === 0) {
    container.innerHTML = "<p>No videos available.</p>";
    return;
  }
  container.innerHTML = "";
  videos.forEach(video => {
    const videoDiv = document.createElement("article");
    videoDiv.className = "video-item";
    videoDiv.innerHTML = `
      <iframe width="100%" height="315" src="${video.url}" frameborder="0" allowfullscreen title="${video.title}"></iframe>
      <h3 style="margin-top:12px;">${video.title}</h3><h3 style="font-size:14px; color:var(--muted);">    by ${video.author}</h3>
    `;
    container.appendChild(videoDiv);
  });
}

async function sendChallenge(opponentId) {
  await supabaseClient
    .from("match_requests")
    .insert({ challenger_id: currentUserId, challenged_id: opponentId, status: "pending" });
  alert("Challenge sent!");
}

function listenForMatchUpdates() {
  supabaseClient.channel("match_updates")
    .on("postgres_changes", { event: "*", schema: "public", table: "match_requests" }, payload => {
      const match = payload.new;
      if (!match) return;

      if (match.challenger_id === currentUserId && match.status === "accepted" && match.game_id) {
        playSound("acceptedSound");
        showJoinBanner(match.game_id);
      }

      if (match.challenged_id === currentUserId && match.status === "pending") {
        playSound("challengeSound");
        showChallengeBanner(match.id, match.challenger_id);
      }
    })
    .subscribe();
}

function playSound(soundId) {
  const sound = document.getElementById(soundId);
  if (!sound) return;
  sound.currentTime = 0;
  sound.play().catch(() => {});
}

function showJoinBanner(gameId) {
  if (document.getElementById("joinBanner")) return;
  const banner = document.createElement("div");
  banner.id = "joinBanner";
  banner.className = "banner";
  banner.setAttribute("role", "alert");
  banner.textContent = "âœ… Your challenge was accepted! Click to join the game.";
  banner.onclick = () => {
    window.location.href = `play-game.html?game=${gameId}`;
  };
  document.body.appendChild(banner);
}

async function showChallengeBanner(matchId, challengerId) {
  if (document.getElementById("challengeBanner")) return;
  const { data: challenger } = await supabaseClient
    .from("profiles")
    .select("username")
    .eq("id", challengerId)
    .single();

  const banner = document.createElement("div");
  banner.id = "challengeBanner";
  banner.className = "banner";
  banner.setAttribute("role", "alertdialog");
  banner.innerHTML = `ðŸŽ¯ Challenge from <b>${challenger?.username || "Unknown"}</b> 
    <button onclick="acceptChallenge('${matchId}')" id="green" aria-label="Accept Challenge">Accept</button>
    <button onclick="declineChallenge('${matchId}')" id="red" aria-label="Decline Challenge">Decline</button>`;
  document.body.appendChild(banner);
}

async function acceptChallenge(matchId) {
  const { data: match } = await supabaseClient
    .from("match_requests")
    .select("*")
    .eq("id", matchId)
    .single();
  if (!match) return;

  const white = Math.random() < 0.5 ? match.challenger_id : match.challenged_id;
  const black = (white === match.challenger_id) ? match.challenged_id : match.challenger_id;

  const { data: game } = await supabaseClient
    .from("games")
    .insert({ white_id: white, black_id: black, fen: "start" })
    .select()
    .single();

  await supabaseClient
    .from("match_requests")
    .update({ status: "accepted", game_id: game.id })
    .eq("id", matchId);

  document.getElementById("challengeBanner")?.remove();
  window.location.href = `play-game.html?game=${game.id}`;
}

async function declineChallenge(matchId) {
  await supabaseClient
    .from("match_requests")
    .update({ status: "declined" })
    .eq("id", matchId);
  document.getElementById("challengeBanner")?.remove();
}

/* Particles background */
particlesJS("particles-js", {
  particles: {
    number: { value: 100, density: { enable: true, value_area: 800 } },
    color: { value: "#4aa3ff" },
    shape: { type: "circle" },
    opacity: { value: 0.5 },
    size: { value: 3 },
    line_linked: { enable: true, distance: 150, color: "#4aa3ff", opacity: 0.4, width: 1 },
    move: { enable: true, speed: 2 }
  },
  retina_detect: true
});

window.acceptChallenge = acceptChallenge;
window.declineChallenge = declineChallenge;
</script>
</body>
</html>