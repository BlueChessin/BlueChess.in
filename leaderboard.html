<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Blue Chess.in â€“ Online Lobby</title>
<meta name="description" content="Join the Blue Chess.in online lobby to challenge friends and players around the world. Start your match instantly.">
<link rel="shortcut icon" href="files/img/-s-logo.png" type="image/png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
<link rel="stylesheet" href="./files/css/friendRes.css">
<style>
  :root {
    --bg:#0b1f3a;
    --panel:#0f2b55;
    --muted:#aac7ff;
    --brand:#4aa3ff;
    --danger:#ff4d4d;
    --ok:#22c55e;
    --text:#e6f0ff;
    --shadow:rgba(74,163,255,.6);
  }
  body {
    font-family: Inter, sans-serif;
    background: linear-gradient(120deg,#02122a,#0f2b55);
    margin: 0;
    color: var(--text);
    overflow-x: hidden;
  }
  #particles-js {
    position: fixed;
    width: 100%;
    height: 100%;
    z-index: -1;
    top: 0;
    left: 0;
  }
  /* Title Bar */
.title-bar {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  padding: 20px;
  margin: 0;
  background: linear-gradient(90deg, #003467, #0084a4, #22c55e);
  background-size: 200% 200%;
  animation: gradientShift 6s infinite alternate;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.title-bar h1 {
  margin: 0;
  font-size: 2em;
  font-weight: 700;
  color: white;
  letter-spacing: 1px;
  text-shadow: 0 0 8px rgba(255,255,255,.6);
}

.title-logo {
  height: 50px;
  width: auto;
  filter: drop-shadow(0 0 8px rgba(74,163,255,.8));
}

#goHome {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 10px 15px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 12px var(--shadow);
    transition: background .2s, transform .2s;
}

  @keyframes gradientShift {
    from { background-position: 0% 50%; }
    to { background-position: 100% 50%; }
  }
  .container {
    max-width: 900px;
    margin: 30px auto;
    padding: 20px;
  }
  .player-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .player-card {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,.05);
    border: 1px solid rgba(255,255,255,.1);
    padding: 12px 18px;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0,0,0,.3);
    transition: transform .2s, box-shadow .2s;
  }
  .player-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 0 25px var(--shadow);
  }
  .player-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }
  .player-info img {
    width: 64px;
    height: 64px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid var(--brand);
    box-shadow: 0 0 10px var(--shadow);
  }
  .details {
    display: flex;
    flex-direction: column;
  }
  .username {
    font-size: 1.2em;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .badges {
    display: flex;
    gap: 5px;
  }
  .badges img {
    height: 22px;
    border-radius: 4px;
    background: #fff2;
    padding: 2px 2px;
    box-shadow: 0 0 8px var(--shadow);
    width: auto;
  }
  .stats {
    font-size: 0.9em;
    color: var(--muted);
    margin-top: 3px;
  }
  .challenge-btn {
    padding: 10px 16px;
    background: var(--ok);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background .2s, transform .2s;
  }
  .challenge-btn:hover {
    background: #1aa34a;
    transform: scale(1.05);
  }
  .challenge-btn:disabled {
    background: gray;
    cursor: not-allowed;
  }
  #home {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 10px 15px;
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 12px var(--shadow);
    transition: background .2s, transform .2s;
  }
  #home:hover {
    background: #2d8cff;
    transform: scale(1.05);
  }
  /* Banners */
  .banner {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 14px 22px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
    cursor: pointer;
    z-index: 9999;
    animation: floatIn 0.4s ease-out;
  }
  @keyframes floatIn {
    from { opacity: 0; transform: translate(-50%, 20px); }
    to   { opacity: 1; transform: translate(-50%, 0); }
  }
  #joinBanner { background: #28a745; color: white; }
  #challengeBanner { background: #ffc107; color: black; cursor: default; }
  .banner button {
    margin-left: 8px;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
  }
  .banner #green { background: #28a745; color: white; }
  .banner #red { background: #ff4d4d; color: white; }
    .banner button:hover {
        opacity: 0.9;
    }
.players {
  display: flex;
  flex-direction: column;
  gap: 15px;
  max-height: 70vh;
  overflow-y: auto;
  padding-right: 5px;
  --sb-track-color: #232E33;
  --sb-thumb-color: #3f43cc;
  --sb-size: 14px;
}
/* Track */
::-webkit-scrollbar-track {
  background: rgba(0,0,0,.1);
  border-radius: 10px;
}
 
/* Handle */
::-webkit-scrollbar-thumb {
  background: rgba(74,163,255,.6);
  border-radius: 10px;
  border: 6px solid rgba(0,0,0,0);
  background-clip: padding-box;
}
/* Handle on hover */
::-webkit-scrollbar-thumb:hover {
  background: rgba(74,163,255,.9);
  border-radius: 10px;
}
</style>
</head>
<body>

<div id="particles-js"></div>

<!-- Title Bar -->
<header class="title-bar">
    <button id="goHome" onclick="window.location.href='home.html'">Go Home</button>
  <img src="files/img/-w-logo.png" alt="BlueChess.in" class="title-logo">
  <h1> -   Leader Board</h1>
</header>


<div class="container">
  <div class="players"></div>
</div>

<audio id="challengeSound" src="files/sound/challenge.wav" preload="auto"></audio>
<audio id="acceptedSound" src="files/sound/accepted.wav" preload="auto"></audio>

<script type="module">
import { initFriendSystem, sendFriendRequest } from "./files/js/friendRes.js";
initFriendSystem(); // Initialize friend system

const SUPABASE_URL = "https://ruevzmnbhoowmuleeqjb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1ZXZ6bW5iaG9vd211bGVlcWpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzOTUzNTIsImV4cCI6MjA2OTk3MTM1Mn0.tt_xEAqLGiv92mvqhQaEvsjTBE6cmYDC3kkQcyPqsTY";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUserId = null;

// Initialize user
(async function init() {
  const { data: { user }, error } = await supabaseClient.auth.getUser();
  if (error || !user) {
    window.location.href = "index.html";
    return;
  }
  // Banned check
    const { data: profile } = await supabaseClient.from("profiles").select("banned").eq("id", user.id).single();
    if (profile && profile.banned) {
      window.location.href = "banned.html";
      return;
    }

    // Maintenance check
    const { data: settings } = await supabaseClient.from("settings").select("maintenance").limit(1).single();
    if (settings && settings.maintenance) {
      window.location.href = "maintenance.html";
      return;
    }
  currentUserId = user.id;
  listenForMatchUpdates();
  fetchPlayers();
})();

// Fetch and display leaderboard players
async function fetchPlayers() {
    const { data: players, error } = await supabaseClient
        .from("profiles")
        .select("id, username, profile, elo, owner, dev, admin, coadmin")
        .order("elo", { ascending: false }); // sort by ELO descending

    if (error) {
        console.error("Error fetching players:", error);
        return;
    }

    const container = document.querySelector(".players");
    container.innerHTML = "";

    players.forEach((player, index) => {
        const card = document.createElement("div");
        card.className = "player-card";

        const info = document.createElement("div");
        info.className = "player-info";

        const rank = document.createElement("div");
        rank.textContent = `#${index + 1}`; // rank starts at 1
        rank.style.fontWeight = "bold";
        rank.style.fontSize = "1.2em";
        rank.style.marginRight = "15px";
        rank.style.width = "40px";
        rank.style.textAlign = "center";

        if (index === 0) rank.style.color = "gold"; 
        else if (index === 1) rank.style.color = "silver";
        else if (index === 2) rank.style.color = "#cd7f32"; 

    else rank.style.color = "var(--brand)";
    

    if (index === 0) rank.style.fontSize = "30px";
    if (index === 1) rank.style.fontSize = "25px";
    if (index === 2) rank.style.fontSize = "22px";

        const avatarUrl = `${SUPABASE_URL}/storage/v1/object/public/avatars/${player.profile}` || "files/img/profiles/default-avatar.png";
        const avatar = document.createElement("img");
        avatar.src = avatarUrl;
        avatar.alt = player.username;

        const details = document.createElement("div");
        details.className = "details";

        const username = document.createElement("div");
        username.className = "username";
        if (player.id === currentUserId) username.textContent = `${player.username} (You)`;
        else username.textContent = player.username;
        

        // Badges based on flags
        const badgesDiv = document.createElement("div");
        badgesDiv.className = "badges";
        if (player.owner) badgesDiv.innerHTML += `<img src="files/img/badges/owner.png" alt="Owner">`;
        if (player.dev) badgesDiv.innerHTML += `<img src="files/img/badges/dev.png" alt="Dev">`;
        if (player.admin) badgesDiv.innerHTML += `<img src="files/img/badges/admin.png" alt="Admin">`;
        if (player.coadmin) badgesDiv.innerHTML += `<img src="files/img/badges/coadmin.png" alt="Co-admin">`;

        const stats = document.createElement("div");
        stats.className = "stats";
        stats.textContent = "ELO: " + (player.elo ?? 1200);

        details.appendChild(username);
        details.appendChild(badgesDiv);
        details.appendChild(stats);

        info.appendChild(rank);
        info.appendChild(avatar);
        info.appendChild(details);

        const challengeBtn = document.createElement("button");
        challengeBtn.className = "challenge-btn";
        challengeBtn.textContent = "Challenge";
        challengeBtn.onclick = () => sendChallenge(player.id);

        card.appendChild(info);
        card.appendChild(challengeBtn);

        container.appendChild(card);
    });
}


// Send a challenge request
async function sendChallenge(opponentId) {
  await supabaseClient
    .from("match_requests")
    .insert({ challenger_id: currentUserId, challenged_id: opponentId, status: "pending" });
  alert("Challenge sent!");
}

// Listen for match updates
function listenForMatchUpdates() {
  supabaseClient.channel("match_updates")
    .on("postgres_changes", { event: "*", schema: "public", table: "match_requests" }, payload => {
      const match = payload.new;
      if (!match) return;

      if (match.challenger_id === currentUserId && match.status === "accepted" && match.game_id) {
        playSound("acceptedSound");
        showJoinBanner(match.game_id);
      }

      if (match.challenged_id === currentUserId && match.status === "pending") {
        playSound("challengeSound");
        showChallengeBanner(match.id, match.challenger_id);
      }
    })
    .subscribe();
}

// Sounds
function playSound(soundId) {
  const sound = document.getElementById(soundId);
  if (!sound) return;
  sound.currentTime = 0;
  sound.play().catch(() => {});
}

// Banners
function showJoinBanner(gameId) {
  if (document.getElementById("joinBanner")) return;
  const banner = document.createElement("div");
  banner.id = "joinBanner";
  banner.className = "banner";
  banner.textContent = "âœ… Your challenge was accepted! Click to join the game.";
  banner.onclick = () => window.location.href = `play-game.html?game=${gameId}`;
  document.body.appendChild(banner);
}

async function showChallengeBanner(matchId, challengerId) {
  if (document.getElementById("challengeBanner")) return;

  const { data: challenger } = await supabaseClient
    .from("profiles")
    .select("username")
    .eq("id", challengerId)
    .single();

  const banner = document.createElement("div");
  banner.id = "challengeBanner";
  banner.className = "banner";
  banner.innerHTML = `ðŸŽ¯ Challenge from <b>${challenger?.username || "Unknown"}</b>
    <button onclick="acceptChallenge('${matchId}')" id="green">Accept</button>
    <button onclick="declineChallenge('${matchId}')" id="red">Decline</button>`;
  document.body.appendChild(banner);
}

// Accept/Decline
async function acceptChallenge(matchId) {
  const { data: match } = await supabaseClient
    .from("match_requests")
    .select("*")
    .eq("id", matchId)
    .single();
  if (!match) return;

  const white = Math.random() < 0.5 ? match.challenger_id : match.challenged_id;
  const black = white === match.challenger_id ? match.challenged_id : match.challenger_id;

  const { data: game } = await supabaseClient
    .from("games")
    .insert({ white_id: white, black_id: black, fen: "start" })
    .select()
    .single();

  await supabaseClient
    .from("match_requests")
    .update({ status: "accepted", game_id: game.id })
    .eq("id", matchId);

  document.getElementById("challengeBanner")?.remove();
  window.location.href = `play-game.html?game=${game.id}`;
}

async function declineChallenge(matchId) {
  await supabaseClient
    .from("match_requests")
    .update({ status: "declined" })
    .eq("id", matchId);
  document.getElementById("challengeBanner")?.remove();
}

// Expose globally for inline buttons
window.acceptChallenge = acceptChallenge;
window.declineChallenge = declineChallenge;
</script>
</body>
</html>
